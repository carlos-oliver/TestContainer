using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc.Testing;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Testcontainers.MsSql;
using Xunit;

public class ApiIntegrationTests : IAsyncLifetime
{
    private readonly MsSqlContainer _sqlContainer;
    private HttpClient _client;
    private WebApplicationFactory<Program> _factory;
    private string _connectionString;

    public ApiIntegrationTests()
    {
        _sqlContainer = new MsSqlBuilder()
            .WithImage("mcr.microsoft.com/mssql/server:2019-latest")
            .WithPassword("YourStrong(!)Password")
            .Build();
    }

    public async Task InitializeAsync()
    {
        // Inicia o container SQL Server
        await _sqlContainer.StartAsync();
        _connectionString = _sqlContainer.GetConnectionString();

        _factory = new WebApplicationFactory<Program>()
            .WithWebHostBuilder(builder =>
            {
                builder.ConfigureAppConfiguration((context, config) =>
                {
                    // Sobrescreve a ConnectionString para usar o container
                    var memoryConfig = new Dictionary<string, string?>
                    {
                        { "ConnectionStrings:DefaultConnection", _connectionString }
                    };
                    config.AddInMemoryCollection(memoryConfig);
                });
            });

        _client = _factory.CreateClient();

        await InitializeDatabase();
    }

    private async Task InitializeDatabase()
    {
        using var connection = new SqlConnection(_connectionString);
        await connection.OpenAsync();

        var command = connection.CreateCommand();
        command.CommandText = @"
            CREATE TABLE Usuarios (
                Id INT PRIMARY KEY IDENTITY,
                Nome NVARCHAR(100) NOT NULL
            );

            INSERT INTO Usuarios (Nome) VALUES ('João'), ('Maria');";
        await command.ExecuteNonQueryAsync();
    }

    public async Task DisposeAsync()
    {
        await _sqlContainer.DisposeAsync();
    }

    [Fact]
    public async Task Deve_Retornar_Usuarios_Do_Banco()
    {
        var response = await _client.GetAsync("/api/usuarios");
        response.EnsureSuccessStatusCode();
        
        var content = await response.Content.ReadAsStringAsync();
        Assert.Contains("João", content);
        Assert.Contains("Maria", content);
    }
}
